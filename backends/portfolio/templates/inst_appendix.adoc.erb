<<<
[appendix]
== Instruction Details

<% portfolio_design.in_scope_instructions.each do |inst| -%>
<<<
<%= anchor_for_udb_doc_inst(inst.name) %>
=== <%= inst.name %>

*<%= inst.long_name %>*

This instruction is defined by:

<%= inst.defined_by_condition.to_asciidoc %>

==== Encoding

<% if inst.multi_encoding? -%>
[NOTE]
This instruction has different encodings in RV32 and RV64.

[tabs]
====
RV32::
+
[wavedrom, ,svg,subs='attributes',width="100%"]
....
<%= JSON.dump inst.wavedrom_desc(32) %>
....

RV64::
+
[wavedrom, ,svg,subs='attributes',width="100%"]
....
<%= JSON.dump inst.wavedrom_desc(64) %>
....
====
<% else -%>
[wavedrom, ,svg,subs='attributes',width="100%"]
....
<%= JSON.dump inst.wavedrom_desc(inst.base.nil? ? 32 : inst.base) %>
....
<% end -%>

==== Synopsis

<%= inst.description %>

==== Access
<% if portfolio_design.in_scope_extensions.any? { |e| e.name == "H" } -%>
[cols="^,^,^,^,^"]
<% else -%>
[cols="^,^,^"]
<% end -%>
|===
| M | <% if portfolio_design.in_scope_extensions.any? { |e| e.name == "H" } -%>HS<% else -%>S<% end -%> | U <% if portfolio_design.in_scope_extensions.any? { |e| e.name == "H" } -%> | VS | VU <% end -%>

| [.access-always]#Always#
| [.access-<%=inst.access['s']%>]#<%= inst.access['s'].capitalize %>#
| [.access-<%=inst.access['u']%>]#<%= inst.access['u'].capitalize %>#
<% if portfolio_design.in_scope_extensions.any? { |e| e.name == "H" } %>
| [.access-<%=inst.access['vs']%>]#<%= inst.access['vs'].capitalize %>#
| [.access-<%=inst.access['vu']%>]#<%= inst.access['vu'].capitalize %>#
<% end %>
|===

<% if inst.access_detail? -%>
<%= inst.access_detail %>
<% end -%>

==== Decode Variables

<% if inst.multi_encoding? -%>
[tabs]
====
RV32::
+
[source.idl]
----
<% inst.decode_variables(32).each do |d| -%>
<%= d.sext? ? 'signed ' : '' %>Bits<<%= d.size %>> <%= d.name %> = <%= d.extract %>;
<% end -%>
----

RV64::
+
[source,idl]
----
<% inst.decode_variables(64).each do |d| -%>
<%= d.sext? ? 'signed ' : '' %>Bits<<%= d.size %>> <%= d.name %> = <%= d.extract %>;
<% end -%>
----
====
<% else -%>
[source,idl]
----
<% inst.decode_variables(inst.base.nil? ? 32 : inst.base).each do |d| -%>
<%= d.sext? ? 'signed ' : '' %>Bits<<%= d.size %>> <%= d.name %> = <%= d.extract %>;
<% end -%>
----
<% end -%>

==== IDL Operation

<% xlens = inst.base.nil? ? [32, 64] : [inst.base] -%>

<% if inst.key?("operation()") -%>
[source,idl,subs="specialchars,macros"]
----
<%= inst.operation_ast(design.symtab).gen_adoc %>
----
<% end -%>

==== Exceptions

<% exception_list = inst.reachable_exceptions_str(design.symtab) -%>
<% if exception_list.empty? -%>
This instruction does not generate synchronous exceptions.
<% else -%>
This instruction may result in the following synchronous exceptions:

  <% exception_list.sort.each do |etype| -%>
  * <%= etype %>
  <% end -%>

<% end -%>

<% unless inst.cert_coverage_points.empty? -%>
==== Certification Coverage Points

[%autowidth]
|===
| Name | Description | Links

<% inst.cert_coverage_points.each do |cp| -%>
| <%= cp.name %>
| <%= cp.description %>
a| <% cp.cert_links.each do |link| -%>
* <%= link.to_adoc %>
<% end # each link -%>
<% end # each coverage point -%>
|===

<% end # unless no coverage points -%>

<% unless inst.cert_test_procedures.empty? -%>
==== Certification Test Procedures

[%autowidth]
|===
| Name | Description | Coverage Points | Steps

<% inst.cert_test_procedures.each do |tp| -%>
| <%= tp.name %>
| <%= tp.description %>
a| <% tp.cert_coverage_points.each do |cp| -%>
* <%= cp.name %>
<% end # each cp -%>
a| <% tp.cert_steps.each do |step| -%>
. <%= step.name %>
* <%= step.description %>
<%= step.note.nil? ? "" : "* " + step.note %>
<% end # each step -%>
<% end # each test plan -%>
|===

<% end # unless no test plans -%>

<% end # each in_scope instruction -%>
